<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Rc&lt;T&gt;，引用计数智能指针 - Rust编程语言</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="ferris.css">
        <link rel="stylesheet" href="theme/2018-edition.css">
        <link rel="stylesheet" href="theme/semantic-notes.css">
        <link rel="stylesheet" href="theme/listing.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rust编程语言</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/lxqddd/rust-book-cn" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="rct引用计数的智能指针"><a class="header" href="#rct引用计数的智能指针"><code>Rc&lt;T&gt;</code>，引用计数的智能指针</a></h2>
<p>在大多数情况下，所有权是明确的：你可以确切地知道哪个变量拥有某个值。然而，有些情况下，一个值可能会有多个所有者。例如，在图数据结构中，多个边可能指向同一个节点，而这个节点在概念上是由所有指向它的边共同拥有的。除非没有任何边指向该节点，否则该节点不应该被清理。</p>
<p>你必须通过使用 Rust 类型 <code>Rc&lt;T&gt;</code> 来显式地启用多重所有权，<code>Rc&lt;T&gt;</code> 是 <em>reference counting</em>（引用计数）的缩写。<code>Rc&lt;T&gt;</code> 类型会跟踪一个值的引用数量，以确定该值是否仍在被使用。如果某个值的引用数量为零，那么该值可以被清理，而不会导致任何引用失效。</p>
<p>你可以把 <code>Rc&lt;T&gt;</code> 想象成家庭房间里的电视。当一个人进入房间看电视时，他们会打开电视。其他人也可以进入房间并观看电视。当最后一个人离开房间时，他们会关闭电视，因为电视不再被使用。如果有人在其他人还在看电视时关闭电视，那么剩下的观众会感到非常不满！</p>
<p>当我们希望在堆上分配一些数据，以便程序的多个部分可以读取，并且我们无法在编译时确定哪个部分会最后使用这些数据时，我们会使用 <code>Rc&lt;T&gt;</code> 类型。如果我们知道哪个部分会最后使用数据，我们可以直接让该部分成为数据的所有者，并在编译时强制执行正常的所有权规则。</p>
<p>需要注意的是，<code>Rc&lt;T&gt;</code> 仅适用于单线程场景。当我们在第 16 章讨论并发时，我们会介绍如何在多线程程序中进行引用计数。</p>
<h3 id="使用-rct-共享数据"><a class="header" href="#使用-rct-共享数据">使用 <code>Rc&lt;T&gt;</code> 共享数据</a></h3>
<p>让我们回到 Listing 15-5 中的 cons 列表示例。回想一下，我们使用 <code>Box&lt;T&gt;</code> 定义了它。这次，我们将创建两个列表，它们共同拥有第三个列表的所有权。从概念上讲，这类似于图 15-3。</p>
<img alt="两个列表共享第三个列表的所有权" src="img/trpl15-03.svg" class="center" />
<p><span class="caption">图 15-3：两个列表 <code>b</code> 和 <code>c</code>，共享第三个列表 <code>a</code> 的所有权</span></p>
<p>我们将创建一个包含 <code>5</code> 和 <code>10</code> 的列表 <code>a</code>。然后我们再创建两个列表：<code>b</code> 以 <code>3</code> 开头，<code>c</code> 以 <code>4</code> 开头。<code>b</code> 和 <code>c</code> 列表随后都会继续到包含 <code>5</code> 和 <code>10</code> 的第一个列表 <code>a</code>。换句话说，这两个列表将共享包含 <code>5</code> 和 <code>10</code> 的第一个列表。</p>
<p>尝试使用我们定义的 <code>List</code> 和 <code>Box&lt;T&gt;</code> 来实现这个场景是行不通的，如 Listing 15-17 所示：</p>
<figure class="listing">
<span class="file-name">Filename: src/main.rs</span>
<pre><code class="language-rust ignore does_not_compile">enum List {
    Cons(i32, Box&lt;List&gt;),
    Nil,
}

use crate::List::{Cons, Nil};

fn main() {
    let a = Cons(5, Box::new(Cons(10, Box::new(Nil))));
    let b = Cons(3, Box::new(a));
    let c = Cons(4, Box::new(a));
}</code></pre>
<figcaption>Listing 15-17: 演示我们不允许有两个使用 <code>Box&lt;T&gt;</code> 的列表尝试共享第三个列表的所有权</figcaption>
</figure>
<p>当我们编译这段代码时，会得到以下错误：</p>
<pre><code class="language-console">$ cargo run
   Compiling cons-list v0.1.0 (file:///projects/cons-list)
error[E0382]: use of moved value: `a`
  --&gt; src/main.rs:11:30
   |
9  |     let a = Cons(5, Box::new(Cons(10, Box::new(Nil))));
   |         - move occurs because `a` has type `List`, which does not implement the `Copy` trait
10 |     let b = Cons(3, Box::new(a));
   |                              - value moved here
11 |     let c = Cons(4, Box::new(a));
   |                              ^ value used here after move

For more information about this error, try `rustc --explain E0382`.
error: could not compile `cons-list` (bin "cons-list") due to 1 previous error
</code></pre>
<p><code>Cons</code> 变体拥有它们所持有的数据，因此当我们创建列表 <code>b</code> 时，<code>a</code> 被移动到 <code>b</code> 中，<code>b</code> 拥有了 <code>a</code>。然后，当我们在创建 <code>c</code> 时再次使用 <code>a</code>，这是不允许的，因为 <code>a</code> 已经被移动了。</p>
<p>我们可以修改 <code>Cons</code> 的定义，使其持有引用而不是数据，但这样我们就必须指定生命周期参数。通过指定生命周期参数，我们就是在指定列表中的每个元素至少要与整个列表一样长。这在 Listing 15-17 中的元素和列表中是成立的，但并非在所有场景中都成立。</p>
<p>相反，我们将修改 <code>List</code> 的定义，使用 <code>Rc&lt;T&gt;</code> 代替 <code>Box&lt;T&gt;</code>，如 Listing 15-18 所示。每个 <code>Cons</code> 变体现在将持有一个值和一个指向 <code>List</code> 的 <code>Rc&lt;T&gt;</code>。当我们创建 <code>b</code> 时，不再获取 <code>a</code> 的所有权，而是克隆 <code>a</code> 所持有的 <code>Rc&lt;List&gt;</code>，从而将引用计数从 1 增加到 2，并让 <code>a</code> 和 <code>b</code> 共享该 <code>Rc&lt;List&gt;</code> 中的数据的所有权。在创建 <code>c</code> 时，我们也会克隆 <code>a</code>，将引用计数从 2 增加到 3。每次我们调用 <code>Rc::clone</code> 时，<code>Rc&lt;List&gt;</code> 内部数据的引用计数都会增加，除非引用计数为零，否则数据不会被清理。</p>
<figure class="listing">
<span class="file-name">Filename: src/main.rs</span>
<pre><pre class="playground"><code class="language-rust edition2024">enum List {
    Cons(i32, Rc&lt;List&gt;),
    Nil,
}

use crate::List::{Cons, Nil};
use std::rc::Rc;

fn main() {
    let a = Rc::new(Cons(5, Rc::new(Cons(10, Rc::new(Nil)))));
    let b = Cons(3, Rc::clone(&amp;a));
    let c = Cons(4, Rc::clone(&amp;a));
}</code></pre></pre>
<figcaption>Listing 15-18: 使用 <code>Rc&lt;T&gt;</code> 的 <code>List</code> 定义</figcaption>
</figure>
<p>我们需要添加一个 <code>use</code> 语句将 <code>Rc&lt;T&gt;</code> 引入作用域，因为它不在预导入模块中。在 <code>main</code> 函数中，我们创建包含 5 和 10 的列表，并将其存储在 <code>a</code> 的一个新的 <code>Rc&lt;List&gt;</code> 中。然后当我们创建 <code>b</code> 和 <code>c</code> 时，我们调用 <code>Rc::clone</code> 函数，并将 <code>a</code> 中的 <code>Rc&lt;List&gt;</code> 的引用作为参数传递。</p>
<p>我们可以调用 <code>a.clone()</code> 而不是 <code>Rc::clone(&amp;a)</code>，但 Rust 的惯例是在这种情况下使用 <code>Rc::clone</code>。<code>Rc::clone</code> 的实现不会像大多数类型的 <code>clone</code> 实现那样对所有数据进行深拷贝。调用 <code>Rc::clone</code> 只会增加引用计数，这不会花费太多时间。数据的深拷贝可能会花费很多时间。通过使用 <code>Rc::clone</code> 进行引用计数，我们可以在视觉上区分深拷贝类型的克隆和增加引用计数的克隆。在代码中寻找性能问题时，我们只需要考虑深拷贝类型的克隆，而可以忽略对 <code>Rc::clone</code> 的调用。</p>
<h3 id="克隆-rct-会增加引用计数"><a class="header" href="#克隆-rct-会增加引用计数">克隆 <code>Rc&lt;T&gt;</code> 会增加引用计数</a></h3>
<p>让我们修改 Listing 15-18 中的工作示例，以便我们可以看到在创建和丢弃对 <code>a</code> 中 <code>Rc&lt;List&gt;</code> 的引用时，引用计数的变化。</p>
<p>在 Listing 15-19 中，我们将修改 <code>main</code> 函数，使其在列表 <code>c</code> 周围有一个内部作用域；然后我们可以看到当 <code>c</code> 离开作用域时，引用计数如何变化。</p>
<figure class="listing">
<span class="file-name">Filename: src/main.rs</span>
<pre><pre class="playground"><code class="language-rust edition2024"><span class="boring">enum List {
</span><span class="boring">    Cons(i32, Rc&lt;List&gt;),
</span><span class="boring">    Nil,
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">use crate::List::{Cons, Nil};
</span><span class="boring">use std::rc::Rc;
</span><span class="boring">
</span>fn main() {
    let a = Rc::new(Cons(5, Rc::new(Cons(10, Rc::new(Nil)))));
    println!("count after creating a = {}", Rc::strong_count(&amp;a));
    let b = Cons(3, Rc::clone(&amp;a));
    println!("count after creating b = {}", Rc::strong_count(&amp;a));
    {
        let c = Cons(4, Rc::clone(&amp;a));
        println!("count after creating c = {}", Rc::strong_count(&amp;a));
    }
    println!("count after c goes out of scope = {}", Rc::strong_count(&amp;a));
}</code></pre></pre>
<figcaption>Listing 15-19: 打印引用计数</figcaption>
</figure>
<p>在程序中引用计数变化的每个点，我们都会打印引用计数，这是通过调用 <code>Rc::strong_count</code> 函数获得的。这个函数名为 <code>strong_count</code> 而不是 <code>count</code>，因为 <code>Rc&lt;T&gt;</code> 类型还有一个 <code>weak_count</code>；我们将在 <a href="ch15-06-reference-cycles.html#preventing-reference-cycles-turning-an-rct-into-a-weakt">“使用 <code>Weak&lt;T&gt;</code> 防止引用循环”</a><!-- ignore --> 中看到 <code>weak_count</code> 的用途。</p>
<p>这段代码会打印以下内容：</p>
<pre><code class="language-console">$ cargo run
   Compiling cons-list v0.1.0 (file:///projects/cons-list)
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.45s
     Running `target/debug/cons-list`
count after creating a = 1
count after creating b = 2
count after creating c = 3
count after c goes out of scope = 2
</code></pre>
<p>我们可以看到，<code>a</code> 中的 <code>Rc&lt;List&gt;</code> 初始引用计数为 1；然后每次我们调用 <code>clone</code> 时，计数都会增加 1。当 <code>c</code> 离开作用域时，计数减少 1。我们不需要调用函数来减少引用计数，就像我们需要调用 <code>Rc::clone</code> 来增加引用计数一样：<code>Drop</code> trait 的实现会在 <code>Rc&lt;T&gt;</code> 值离开作用域时自动减少引用计数。</p>
<p>在这个示例中我们看不到的是，当 <code>b</code> 和 <code>a</code> 在 <code>main</code> 函数结束时离开作用域时，计数变为 0，<code>Rc&lt;List&gt;</code> 被完全清理。使用 <code>Rc&lt;T&gt;</code> 允许一个值有多个所有者，而计数确保只要任何所有者仍然存在，该值就保持有效。</p>
<p>通过不可变引用，<code>Rc&lt;T&gt;</code> 允许你在程序的多个部分之间共享数据以供只读。如果 <code>Rc&lt;T&gt;</code> 也允许你拥有多个可变引用，你可能会违反第 4 章讨论的借用规则之一：对同一位置的多个可变借用可能导致数据竞争和不一致。但能够改变数据是非常有用的！在下一节中，我们将讨论内部可变性模式以及你可以与 <code>Rc&lt;T&gt;</code> 结合使用的 <code>RefCell&lt;T&gt;</code> 类型，以应对这种不可变性限制。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ch15-03-drop.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="ch15-05-interior-mutability.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ch15-03-drop.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="ch15-05-interior-mutability.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="ferris.js"></script>


    </div>
    </body>
</html>
